<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<title>KML 火车模拟（游览编辑器）</title>
	<style>
		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			margin: 0;
			padding: 20px;
			background-color: #f4f4f9;
			display: flex;
			flex-direction: column;
			align-items: center;
		}
		.container {
			width: 100%;
			max-width: 800px;
			background: #fff;
			padding: 25px;
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		}
		h1 {
			color: #333;
			text-align: center;
			margin-bottom: 20px;
		}
		.control-group {
			margin-bottom: 20px;
			display: grid;
			grid-template-columns: 120px 1fr;
			align-items: center;
			gap: 15px;
		}
		label {
			font-weight: 600;
			color: #555;
			text-align: right;
		}
		.input-wrapper {
			display: flex;
			align-items: center;
		}
		input[type="file"],
		input[type="number"] {
			width: 100%;
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 4px;
			box-sizing: border-box;
			font-size: 16px;
		}
		.description-note {
			margin-left: 10px;
			font-size: 14px;
			color: #888;
			white-space: nowrap;
		}
		.info-box {
			grid-column: 1 / -1; /* Span all columns */
			font-size: 14px;
			color: #333;
			background-color: #f0f8ff;
			padding: 15px;
			border-left: 4px solid #007bff;
			border-radius: 4px;
			margin-bottom: 25px;
		}
		.info-box h3 {
			margin-top: 0;
		}
		button {
			grid-column: 1 / -1;
			width: 100%;
			padding: 12px;
			background-color: #007bff;
			color: white;
			border: none;
			border-radius: 4px;
			font-size: 18px;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}
		button:disabled {
			background-color: #ccc;
			cursor: not-allowed;
		}
		textarea {
			grid-column: 1 / -1;
			width: 100%;
			height: 400px;
			margin-top: 20px;
			border: 1px solid #ccc;
			border-radius: 4px;
			font-family: monospace;
			white-space: pre;
			overflow: auto;
			font-size: 14px;
			padding: 10px;
			box-sizing: border-box;
		}
	</style>
</head>
<body>

<div class="container">
	<h1>KML 火车模拟</h1>

	<div class="info-box">
		<h3>功能文件说明</h3>
		<p>目前，本页面程序主要用来帮助大家模拟火车路线运行，通过修改KML游览文件的<b>线段长度（行进时间）</b>和<b>俯瞰高度</b>来实现。</p>
		<h3>使用说明：</h3>
		<ol>
			<li>在Google Earth Pro中，右键点击您的路径（Tracks），选择“添加” -> “游览”。</li>
			<li>在左下角出现的游览工具栏中，点击录制按钮，然后立即点击播放按钮，让它自动沿线路飞行一遍后停止录制。</li>
			<li>在“位置”面板中，将生成的“无标题游览”保存为KML文件。</li>
			<li>将这个KML文件上传到本页面，设置您想要的参数，然后生成并下载新的KML文件。</li>
		</ol>
	</div>

	<div class="control-group">
		<label for="kmlFile">文件上传:</label>
		<div class="input-wrapper">
			<input type="file" id="kmlFile" accept=".kml">
			<span class="description-note">仅支持.KML文件</span>
		</div>
	</div>

	<div class="control-group">
		<label for="duration">线段长度:</label>
		<div class="input-wrapper">
			<input type="number" id="duration" value="3" min="1" max="1000" step="1">
			<span class="description-note">(秒, 1-1000, 默认3)</span>
		</div>
	</div>

	<div class="control-group">
		<label for="altitude">俯瞰高度:</label>
		<div class="input-wrapper">
			<input type="number" id="altitude" placeholder="默认35000" min="0" max="900000" step="100">
			<span class="description-note">(米, 不填写则不修改)</span>
		</div>
	</div>

	<button id="generateBtn" disabled>请先加载KML文件</button>

	<textarea id="outputKml" readonly placeholder="这里将显示修改后的KML内容..."></textarea>
</div>

<script>
	const fileInput = document.getElementById('kmlFile');
	const durationInput = document.getElementById('duration');
	const altitudeInput = document.getElementById('altitude');
	const generateBtn = document.getElementById('generateBtn');
	const outputKmlTextarea = document.getElementById('outputKml');

	let kmlContentStore = '';

	fileInput.addEventListener('change', (event) => {
		const file = event.target.files[0];
		if (file) {
			const reader = new FileReader();
			reader.onload = (e) => {
				kmlContentStore = e.target.result;
				generateBtn.disabled = false;
				generateBtn.textContent = '生成模拟KML';
				alert('文件加载成功！');
			};
			reader.readAsText(file);
		} else {
			kmlContentStore = '';
			generateBtn.disabled = true;
			generateBtn.textContent = '请先加载KML文件';
		}
	});

	generateBtn.addEventListener('click', () => {
		if (!kmlContentStore) {
			alert('错误：没有加载KML文件。');
			return;
		}

		try {
			const parser = new DOMParser();
			const kmlDoc = parser.parseFromString(kmlContentStore, "application/xml");

			const parseError = kmlDoc.querySelector("parsererror");
			if (parseError) {
				throw new Error("KML文件格式错误，无法解析。");
			}

			// KML 使用命名空间，特别是 gx:Tour
			const flyToElements = kmlDoc.getElementsByTagName('gx:FlyTo');

			if (flyToElements.length === 0) {
				throw new Error("未在此KML文件中找到 <gx:Tour> 或 <gx:FlyTo> 元素。请确保上传的是一个Google Earth游览文件。");
			}

			const durationValue = durationInput.value;
			const altitudeValue = altitudeInput.value;

			let modifiedCount = 0;

			for (const flyTo of flyToElements) {
				// 1. 修改线段长度 (gx:duration)
				if (durationValue) {
					let durationElement = flyTo.getElementsByTagName('gx:duration')[0];
					if (!durationElement) {
						// 如果不存在，则创建一个
						durationElement = kmlDoc.createElementNS('http://www.google.com/kml/ext/2.2', 'gx:duration');
						flyTo.appendChild(durationElement);
					}
					durationElement.textContent = durationValue;
				}

				// 2. 修改俯瞰高度 (altitude)
				if (altitudeValue) {
					const cameraElement = flyTo.getElementsByTagName('Camera')[0];
					const lookAtElement = flyTo.getElementsByTagName('LookAt')[0];
					const viewElement = cameraElement || lookAtElement;

					if (viewElement) {
						let altitudeElement = viewElement.getElementsByTagName('altitude')[0];
						if (altitudeElement) {
							altitudeElement.textContent = altitudeValue;
						}
					}
				}
				modifiedCount++;
			}

			const serializer = new XMLSerializer();
			const newKmlString = serializer.serializeToString(kmlDoc);

			outputKmlTextarea.value = newKmlString;
			alert(`处理完成！共修改了 ${modifiedCount} 个游览路段。`);

		} catch (error) {
			alert('处理失败: ' + error.message);
			outputKmlTextarea.value = '';
		}
	});
</script>

</body>
</html>