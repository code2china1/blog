<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>KML Tour 转换工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 200px; margin: 10px 0; font-family: monospace; }
        label { display: inline-block; margin: 5px 10px 5px 0; }
        .config { margin: 10px 0; }
        button { padding: 6px 12px; margin-right: 10px; }
        #summary { margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        th { background: #eee; }
    </style>
</head>
<body>
<h2>KML Tour 转换工具</h2>

<label>输入 KML 内容：</label>
<textarea id="inputKml"></textarea>

<div class="config">
    <label>过渡时间(s):
        <input type="number" id="animatedDuration" value="1" step="0.1">
    </label>
    <label>停顿时间(s):
        <input type="number" id="waitDuration" value="1" step="0.1">
    </label>
    <label>模式:
        <select id="mode">
            <option value="fade">渐变</option>
            <option value="instant">瞬间+停顿</option>
        </select>
    </label>
    <label>
        <input type="checkbox" id="useWait" checked> 每步后加 Wait
    </label>
</div>

<button onclick="convertKml()">转换</button>
<button onclick="copyResult()">一键复制结果</button>

<h3>输出结果：</h3>
<textarea id="outputKml" readonly></textarea>

<h3>元素统计：</h3>
<div id="summary"></div>
<div id="summaryTable"></div>
<h3>汇总统计：</h3>
<div id="aggregateTable"></div>

<script>
    function convertKml() {
        const input = document.getElementById("inputKml").value;
        const animatedDuration = parseFloat(document.getElementById("animatedDuration").value) || 1;
        const waitDuration = parseFloat(document.getElementById("waitDuration").value) || 1;
        const mode = document.getElementById("mode").value;
        const useWait = document.getElementById("useWait").checked;

        const lines = input.split("\n");
        let result = "";
        let elementCount = 0;
        let uniqueIds = new Set();
        let tableRows = [];
        let aggregate = {}; // { targetId: {show: n, hide: n} }

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            result += line + "\n";

            if (line.includes("<gx:AnimatedUpdate>")) {
                elementCount++;
                if (mode === "instant") {
                    result += "        <gx:duration>0</gx:duration>\n";
                } else {
                    result += "        <gx:duration>" + animatedDuration + "</gx:duration>\n";
                }
            }

            if (line.includes("<Placemark")) {
                const match = line.match(/targetId="([^"]+)"/);
                if (match) {
                    uniqueIds.add(match[1]);
                    tableRows.push({ index: elementCount, targetId: match[1], action: "未知" });
                }
            }

            if (line.includes("<visibility>")) {
                const visMatch = line.match(/<visibility>(\d)<\/visibility>/);
                if (visMatch && tableRows.length > 0) {
                    const lastRow = tableRows[tableRows.length - 1];
                    lastRow.action = visMatch[1] === "1" ? "显示" : "隐藏";

                    // 更新汇总统计
                    const id = lastRow.targetId;
                    if (!aggregate[id]) aggregate[id] = { show: 0, hide: 0 };
                    if (visMatch[1] === "1") {
                        aggregate[id].show++;
                    } else {
                        aggregate[id].hide++;
                    }
                }
            }

            if (line.includes("</gx:AnimatedUpdate>") && useWait) {
                result += "      <gx:Wait><gx:duration>" + waitDuration + "</gx:duration></gx:Wait>\n";
            }
        }

        document.getElementById("outputKml").value = result;

        // 文本统计
        let summaryText = "共找到 " + elementCount + " 个 <gx:AnimatedUpdate> 元素<br>";
        summaryText += "涉及 " + uniqueIds.size + " 个唯一的 Placemark targetId: " + Array.from(uniqueIds).join(", ");
        document.getElementById("summary").innerHTML = summaryText;

        // 表格统计
        let tableHtml = "<table><tr><th>#</th><th>Placemark targetId</th><th>动作类型</th></tr>";
        tableRows.forEach(row => {
            tableHtml += "<tr><td>" + row.index + "</td><td>" + row.targetId + "</td><td>" + row.action + "</td></tr>";
        });
        tableHtml += "</table>";
        document.getElementById("summaryTable").innerHTML = tableHtml;

        // 汇总统计表
        let aggHtml = "<table><tr><th>Placemark targetId</th><th>显示次数</th><th>隐藏次数</th></tr>";
        for (let id in aggregate) {
            aggHtml += "<tr><td>" + id + "</td><td>" + aggregate[id].show + "</td><td>" + aggregate[id].hide + "</td></tr>";
        }
        aggHtml += "</table>";
        document.getElementById("aggregateTable").innerHTML = aggHtml;
    }

    function copyResult() {
        const output = document.getElementById("outputKml");
        output.select();
        document.execCommand("copy");
        alert("结果已复制到剪贴板！");
    }
</script>
</body>
</html>
