<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>KML Tour Wait 插入工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 220px; margin: 10px 0; font-family: monospace; }
        label { margin-right: 10px; }
        button { padding: 6px 12px; margin-right: 10px; }
    </style>
</head>
<body>
<h2>KML Tour Wait 插入工具</h2>

<label>显示后停顿时间 (秒):
    <input type="number" id="waitTime" value="2" step="0.1">
</label>
<br><br>
<button onclick="processKml()">转换</button>
<button onclick="copyResult()">复制结果</button>

<h3>输入 KML：</h3>
<textarea id="inputKml" placeholder="粘贴 KML..."></textarea>

<h3>输出 KML：</h3>
<textarea id="outputKml" readonly></textarea>

<script>
    function processKml() {
        const input = document.getElementById("inputKml").value;
        const waitTime = parseFloat(document.getElementById("waitTime").value) || 2;

        // 清除所有 <gx:Wait> 块
        let cleaned = input.replace(/<gx:Wait>[\s\S]*?<\/gx:Wait>/g, "");

        // 清除所有 <gx:duration>，但保留 FlyTo 内部的
        const lines = cleaned.split(/\n/);
        let result = [];
        let insideFlyTo = false;
        let seenFirstFlyTo = false;

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];

            // 判断是否进入或离开 <gx:FlyTo>
            if (line.includes("<gx:FlyTo>")) {
                insideFlyTo = true;
                seenFirstFlyTo = true;
            }
            if (line.includes("</gx:FlyTo>")) {
                insideFlyTo = false;
            }

            // 删除 <gx:duration>，但保留 FlyTo 内部的
            if (line.includes("<gx:duration>") && !insideFlyTo) {
                continue;
            }

            result.push(line);

            // 在 FlyTo 之后的 AnimatedUpdate 后插入 Wait
            if (line.includes("</gx:AnimatedUpdate>") && seenFirstFlyTo && !insideFlyTo) {
                result.push(`    <gx:Wait><gx:duration>${waitTime}</gx:duration></gx:Wait>`);
            }
        }

        document.getElementById("outputKml").value = result.join("\n");
    }

    function copyResult() {
        const output = document.getElementById("outputKml");
        output.select();
        document.execCommand("copy");
        alert("结果已复制到剪贴板！");
    }
</script>
</body>
</html>
